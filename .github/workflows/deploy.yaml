name: Build and Deploy Flutter Web to GitHub Pages at UPI-QR-MAKER

on:
  push:
    branches: [main]  # or your working branch
    paths:
      - 'flutter_upi/**'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.22.1"
        channel: "stable"

    - name: Upgrade Flutter (optional but recommended)
      run: flutter upgrade

    - name: Check Flutter Version
      run: flutter --version

    - name: Check Dart Version
      run: dart --version

    - name: Enable Web Support
      run: flutter config --enable-web

    - name: Install dependencies
      working-directory: flutter_upi
      run: flutter pub get

    - name: Build Flutter Web (Release) with base href as ./
      working-directory: flutter_upi
      run: flutter build web --release --base-href=./

    - name: Clone GitHub Pages Repo (mrrohanbatra.github.io)
      run: |
        git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/MrRohanBatra/mrrohanbatra.github.io.git pages_repo
        ls pages_repo

    - name: Copy Build Output to pages_repo/UPI-QRCODE-MAKER
      run: |
        rm -rf pages_repo/UPI-QRCODE-MAKER
        mkdir -p pages_repo/UPI-QRCODE-MAKER
        cp -r flutter_upi/build/web/* pages_repo/UPI-QRCODE-MAKER/

    - name: Commit and Push to GitHub Pages
      run: |
        cd pages_repo
        git config user.name "Rohan Batra"
        git config user.email "rohanbatra.in@gmail.com"
        git add .
        git commit -m "ðŸš€ Deploy Flutter Web build to GitHub Pages" || echo "No changes to commit"
        git push